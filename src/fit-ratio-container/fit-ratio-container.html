<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<dom-module id="zoom-container">
  <template>
    <style>
      :host[fit] {
        @apply(--layout-fit);
      }
    </style>
    <content></content>
  </template>
  <script>
    // @ts-check

    const component = {
      is: 'zoom-container',

      behaviors: [
        Polymer.IronResizableBehavior
      ],

      listeners: {
        'iron-resize': '_onIronResize'
      },

      properties: {
        dimensions: {
          type: String,
          value: "1/1",
          observer: '_onDimensionsChanged'
        },

        fit: {
          type: Boolean,
          value: true,
          reflectToAttribute: true,
          observer: "_onFit",
        },

        zoom: {
          type: Number,
          value: 1,  // Relative to the canvas elemt, not the viewport!
          observer: "_onZoom",
        }
      },

      _contentDimensions: {
        width: 1,
        height: 1,
      },

      _ratio: 1,

      _notifyFit: true,

      get contentElement() {
        return this.getContentChildren()[0];
      },

      // Event listeners

      ready: function() {
        // Safari/WebKit doesn't support screen.orientation as of 16.2.
        // The "resize" event (and therefore _onIronResize) gets fired for
        // orientation changes instead.
        if(window.screen.orientation) {
          window.screen.orientation.addEventListener("change", this._onIronResize.bind(this));
        }

        // DEBUGGING
        // @ts-ignore
        window.z = this;
      },

      // IronResizeBehavior event listeners

      _notifyAll: function(element) {
        return true;
      },

      _notifyNone: function(element) {
        return false;
      },

      _onDimensionsChanged: function(newValue, oldValue) {
        var parts = newValue.toString().split("/");

        var width = this._contentDimensions.width = parseFloat(parts[0]);
        var height = this._contentDimensions.height = parseFloat(parts[1] || 1);
        this._ratio = width / height;

        this._onIronResize();
      },

      _onIronResize: function() {
        if(this.resizerShouldNotify == this._notifyAll) {
          return;
        }

        var contentWidth = Math.min(this.offsetWidth, this.offsetHeight * this._ratio);
        var contentHeight = Math.min(this.offsetHeight, this.offsetWidth / this._ratio);

        var horizontalPadding = (this.offsetWidth - contentWidth) / 2.0;
        var verticalPadding = (this.offsetHeight - contentHeight) / 2.0;

        this.style.paddingLeft = this.style.paddingRight = horizontalPadding + "px";
        this.style.paddingTop = this.style.paddingBottom = verticalPadding + "px";

        this.resizerShouldNotify = this._notifyAll;
        this.notifyResize();
        this.resizerShouldNotify = this._notifyNone;

        if(this.fit) {
          this._refitZoom();
        }
      },

      // Zooming event listeners

      _onFit: function(newValue, oldValue) {
        if(!oldValue && this.fit) {
          this._refitZoom();
        }
      },

      _onZoom: function() {
        if(!this._readied) {
          return;
        }

        if(this._notifyFit) {
          this.fit = false;
        }
      },

      _refitZoom: function() {
        this._notifyFit = false;
        const zoom = Math.min(
          this.offsetWidth / this._contentDimensions.width,
          this.offsetHeight / this._contentDimensions.height
        );
        this.zoom = zoom;
        this._notifyFit = true;
      },
    };

    // @ts-ignore
    Polymer(component);
  </script>
</dom-module>
